<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>Calendar Fe Test</title>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        class Calendar extends React.Component {
            constructor(){
                super()
                this.state = {id: '', eventId: '', mode: 'add', selectOption: 'AM', name: '', time: '', bgcolor: '#000000', color: '#fcfcfc', email: ''}
                const datenow = new Date()
                const title = datenow.toLocaleString('default', { month: 'long' })+' '+datenow.getFullYear()
                const allData = JSON.parse(localStorage.getItem('calendarData'))
                if (allData && allData.title == title) {
                    this.state = {...this.state, title: allData.title, dayName: allData.dayName, data: allData.data}
                }
                else {
                    const dayName = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']
                    const firstDay = new Date(datenow.getFullYear(), datenow.getMonth(), 1).getDay()
                    const lastDay = new Date(datenow.getFullYear(), datenow.getMonth()+1, 0).getDate()
                    let data = []
                    for (let start = 0; start < firstDay; start++) {
                        data.push({})                    
                    }
                    for (let day = 1; day <= lastDay; day++) {
                        data.push({id: day})
                    }
                    const saveData = {title: title, dayName: dayName, data: data}
                    this.state = {...this.state, title: title, dayName: dayName, data: data}
                    localStorage.setItem('calendarData', JSON.stringify(saveData))
                }
                
            }

            componentDidMount() {
                document.querySelector('#hiddenID').addEventListener('change', (e) =>
                {
                    this.setState({id: e.target.value})
                    if (e.target.nextSibling && e.target.nextSibling.value) {
                        this.setState({eventId: e.target.nextSibling.value})
                        const allData = JSON.parse(localStorage.getItem('calendarData'))
                        const findindex = allData.data.findIndex(x => x.id == e.target.value)
                        const singleData = allData.data[findindex]
                        const singleDataEvent = singleData.event[e.target.nextSibling.value]
                        const timeString = singleDataEvent.time.split(' ')
                        this.setState({mode: 'edit', selectOption: timeString[1], name: singleDataEvent.name, time: timeString[0], bgcolor: singleDataEvent.bgcolor, color: singleDataEvent.color, email: singleDataEvent.email})
                    }
                })
            }

            onchangeName(e) {
                this.setState({name: e.target.value})
            }
            onchangeEmail(e) {
                this.setState({email: e.target.value})
            }
            onchangeTime(e) {
                this.setState({time: e.target.value})
            }
            onchangeColor(e) {
                this.setState({color: e.target.value})
            }
            onchangeBgColor(e) {
                this.setState({bgcolor: e.target.value})
            }
            onchangeSelect(e) {
                this.setState({selectOption: e.target.value})
            }

            handleSubmitForm = (event) => {
                event.preventDefault()
                if(this.state.name != '' && this.state.email != '' && this.state.time != '') {
                    const {data, id, name, time, email, color, bgcolor, selectOption} = this.state
                    const indexData = data.findIndex(x => x.id == id)
                    let dataSingle = data[indexData]
                    if (dataSingle.event) {
                        if(this.state.mode == "edit") {
                            dataSingle.event[this.state.eventId] = {name: name, time:time+' '+selectOption, email: email, color: color, bgcolor: bgcolor}
                        }
                        else {
                            if(dataSingle.event.length < 3) {
                                dataSingle.event.push({name: name, time:time+' '+selectOption, email: email, color: color, bgcolor: bgcolor})
                            }
                            else {
                                alert("Maximum 3 event")
                            }
                        }
                    }
                    else {
                        dataSingle.event = [{name: name, time:time+' '+selectOption, email: email, color: color, bgcolor: bgcolor}]
                    }
                    data[indexData] = dataSingle
                    this.setState({data: data})
                    const allData = {title: this.state.title, dayName: this.state.dayName, data: data}
                    localStorage.setItem('calendarData', JSON.stringify(allData))
                    document.getElementById('modalOne').style.display = "none"
                    this.setState({id: '', eventId: '', mode: 'add', selectOption: 'AM', name: '', time: '', bgcolor: '#000000', color: '#fcfcfc', email: ''})
                }
                else {
                    alert("Complete the data")
                }
                
            }

            closeModal = () => {
                document.getElementById('modalOne').style.display = "none"
                this.setState({id: '', eventId: '', mode: 'add', selectOption: 'AM', name: '', time: '', bgcolor: '#000000', color: '#fcfcfc', email: ''})
            }

            render () {
                return (
                    <div className="container">
                        <h2 className="title">{this.state.title}</h2>
                        <div className="day-name-container">
                            {this.state.dayName.map((e) => 
                                <DayContainer name={e}/>
                            )}
                        </div>
                        <div className="date-container">
                            {this.state.data.map((data) =>
                                <DateContainer data={data}/>
                            )}
                        </div>
                        <div id="modalOne" className="modal">
                            <div className="modal-content">
                                <div className="contact-form">
                                    <a className="close" onClick={() => this.closeModal()}>&times;</a>
                                    <form onSubmit={this.handleSubmitForm}>
                                        <input type="hidden" className="hidden" name="hiddenID" id="hiddenID" value={this.state.id}/>
                                        <input type="hidden" className="hidden" name="eventID" id="eventID" value={this.state.eventId}/>
                                        <h2>Add Event</h2>
                                        <input type="text" name="name" placeholder="name" value={this.state.name} onChange={(e) => this.onchangeName(e)}/>
                                        <input type="text" name="email" placeholder="Email" value={this.state.email} onChange={(e) => this.onchangeEmail(e)}/>
                                        <input type="number" min="1" max="12" name="time" value={this.state.time} placeholder="time" onChange={(e) => this.onchangeTime(e)}/>
                                        <select value={this.state.selectOption} onChange={(e) =>this.onchangeSelect(e)}><option value="AM">AM</option><option value="PM">PM</option></select>
                                        <div>
                                            <input type="color" id="color" name="color" value={this.state.color} onChange={(e) => this.onchangeColor(e)}/>
                                            <label>Color</label>
                                        </div>
                                        <div>
                                            <input type="color" id="bgcolor" name="bgcolor" value={this.state.bgcolor} onChange={(e) => this.onchangeBgColor(e)}/>
                                            <label>Background Color</label>
                                        </div>
                                        <button type="submit">Submit</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                )
            }
        }

        const DayContainer = (prop) => {
            return (
                <span className="day-name-description" key={prop.name}>{prop.name}</span>
            )
        }

        
        const DateContainer = (prop) => {
            function handleDateClick(id) {
                document.getElementById('modalOne').style.display = "block"
                document.getElementById('hiddenID').value = id
                const e = new Event("change")
                const element = document.querySelector('#hiddenID')
                element.dispatchEvent(e)
            }
            return (
                <div className={prop.data && prop.data.id ? 'date-column': ''} key={prop.data.id}>
                    <p className="date-column-title"  onClick={() => handleDateClick(prop.data.id)}>{prop.data.id}</p>
                    {prop.data && prop.data.event && prop.data.event.map((event, index) =>
                        <EventContainer event={event} id={prop.data.id} eventId={index}/>
                    )}
                </div>
            )
        }

        const EventContainer = (prop) => {
            function handleEditClick(eventid) {
                document.getElementById('hiddenID').value = prop.id
                document.getElementById('eventID').value = eventid
                const e = new Event("change")
                const element = document.querySelector('#hiddenID')
                element.dispatchEvent(e)
                //const f = new Event("change")
                // const elementEvent = document.querySelector('#eventID')
                // elementEvent.dispatchEvent(f)
                document.getElementById('modalOne').style.display = "block"
            }

            function handleRemoveClick(eventid) {
                if (confirm("Are you sure want to delete this?") == true) {
                    const dataFromStorage = JSON.parse(localStorage.getItem('calendarData'))
                    const findindex = dataFromStorage.data.findIndex(x => x.id == prop.id)
                    const singleData = dataFromStorage.data[findindex]
                    singleData.event.splice(eventid, 1)
                    dataFromStorage.data[findindex] = singleData
                    localStorage.setItem('calendarData', JSON.stringify(dataFromStorage))
                    window.location.reload()
                }
            }
            return (
                <div style={{backgroundColor: prop.event.bgcolor, color:prop.event.color}} className="date-column-event-container" key={prop.eventId+''+prop.id}>
                    <span className="date-column-event-icon"><i onClick={() => handleEditClick(prop.eventId)} className="fa fa-pencil-square-o"></i><i onClick={() => handleRemoveClick(prop.eventId)} className="fa fa-trash"></i></span>
                    <p>{prop.event.name}</p>
                    <p>{prop.event.email}</p>
                    <p>{prop.event.time}</p>
                </div>
            )
        }

        const root = document.getElementById("root")
        const rootDom = ReactDOM.createRoot(root)
        rootDom.render(<Calendar />)
    </script>
</body>
</html>